---
title: "线上实验一：线上对照实验概览"
date: "2024-05-24"
keywords: ["AB实验基础概念", "实验功效", "实验可信度"]
series: "Causal-Inference"
---

本文是《Trustworthy Online Controlled Experiments》（中文版《关键迭代：可信赖的线上对照试验》）的第一部分（1-4章）主要内容的总结。

# 第1章：介绍与动机

### 1. 在线对照实验术语
在线对照实验（Online Controlled Experiments，OCE）是一种在互联网上进行的实验方法，用于比较两种或多种不同处理方法（variants）的效果，以确定哪种方法在某些指标上表现更好。常见的术语包括：

1. **综合评估标准（Overall Evaluation Criterion，OEC）**：评估实验目标的定量标准，例如用户活跃天数、使用会话数、广告收入等。在统计学中也称为因变量。
2. **变体（Variant）**：实验中的不同版本。其中，**对照组（Control）**指现有系统或方法，**处理组（Treatment）**指新系统或改进后的方法。
3. **参数（Parameter）**：实验中可控的变量，可能会影响OEC或其他感兴趣的指标。参数的赋值也称为因子水平，多因子实验（如A/B/C/D）的设计很常见。还可以进行多变量测试以同时调整多个参数。
4. **随机化单位（Randomization Unit）**：使用伪随机化过程将实验单元（如用户或页面）分配到不同的变体中，以确保统计上相似的群体分配。

### 2. 有效运行对照实验的必要元素
要运行有效的对照实验，需要具备以下条件：

1. **互不干扰的实验单元**：实验单元（如用户）可以被分配到不同的变体中，且不会互相干扰。例如，实验组的用户不会影响对照组的用户。
2. **足够的实验单元**：确保有足够数量的实验单元（如用户）参与实验，以提高统计检验的灵敏度。
3. **一致同意的关键指标**：关键指标（最好是OEC）应是经过一致同意的，并且可以在实践中被评估。最好能够以低成本广泛收集到可靠的数据。
4. **易于实现的改动**：确保实验中所需的改动容易实现，特别是在软件领域，这通常比硬件改动更容易。

# 第2章：运行和分析实验

### 1. 假设检验：确立统计显著性

- **灵敏度**：灵敏度随着标准差的降低而提高。提高灵敏度的典型方法是分配更多流量到变体，或延长实验运行时间。然而，延长运行时间的方法可能不如前者有效，因为重复访问的用户使得去重用户量的增长呈次线性，并且某些指标的方差也可能随时间增长。
- **计算 $p$ 值**：$p$ 值是在零假设为真时，观察到当前差异或更极端差异的概率。（注意区分统计显著性和实际显著性）
- **统计功效（statistical power）**：在实际存在差异时，拒绝零假设的概率。通常，样本量越大，统计功效越高。

### 2. 设计实验

- **样本量大小**：假设我们有两个实验组，其样本量分别为 $n_1$ 和 $n_2 = kn_1$。在给定显著性水平 $\alpha$、检验功效 $1 - \beta$ 和效应大小 $\Delta$ 的情况下，对于数值型指标（$\Delta = \mu_2 - \mu_1$），样本量 $n_1$ 需要满足：

  $$
  n_1 = \frac{(Z_{1-\alpha/2} + Z_{\beta})^2 \cdot (\sigma_1^2 + \sigma_2^2/k)}{\Delta^2} 
  $$

  对于比率型指标（$\Delta = p_2 - p_1$），样本量 $n_1$ 需要满足：

  $$
  n_1 = \frac{(Z_{1-\alpha/2} + Z_{\beta})^2 \hat{p} (1 - \hat{p}) (1 + \frac{1}{k})}{\Delta^2},\quad \hat{p} = \frac{\hat{p}_1 + k \hat{p}_2}{1 + k}
  $$

  关于样本量的计算公式推导过程请参考[AB实验样本量计算公式](001sample_size.qmd)。

  以下方法可以减少所需样本量：
  1. 使用比率型指标（如转化率）而非数值型指标（如人均收入）作为 OEC，因为比率型参数的标准差通常较小；
  2. 增大实际显著性水平（使 $\Delta$ 变大），由于较大变化更容易被检测到，因此可以减少样本量；
  3. 使用较大的 $p$ 值阈值（增大 $\alpha$ 值），或降低统计功效（增大 $\beta$ 值）。

- **运行周期**：运行时间需要考虑以下因素：
  1. 总时间越长通常代表总用户越多，但某些指标的方差也可能增加；
  2. 周内效应和季节性，需要考虑时间序列分析的周期性；
  3. 初始效应和新奇效应：某些实验在初始阶段可能表现出较大或较小的效应，随后趋于稳定。

# 第3章：实验的可信赖度

### 1. 内部有效性的威胁
1. **个体处理稳定性假设（Stable Unit Treatment Value Assumption，SUTVA）**：实验单元仅受所分配的变体影响，而不受其他人的分配信息影响。但在实际中，这一假设常常不成立，例如社交网络功能的改动。
2. **幸存者偏差**：仅分析长期活跃用户会导致幸存者偏差。
3. **意向性分析（Intention-to-Treat Analysis）**：不能只分析选择参与实验的用户，而应考虑初始随机分配的所有用户，以避免偏差。
4. **样本比率不匹配（Sample Ratio Mismatch，SRM）**：检验实际用户比例与实验设计比例是否一致，确保分配的随机性和代表性。

### 2. 外部有效性的威胁
主要包括初始效应和新奇效应。这些效应可以通过绘制用户在一段时间内的使用情况曲线来检测和分析。

### 3. 细分群的差异（Segment Differences）
好的细分群例子包括：国家或地区、设备或平台、时间（如周中和周末）、用户类型（新用户与老用户）。

**异质性处理效应（Heterogeneous Treatment Effects）**：实验效应在不同细分群之间可能表现出差异，而不是均匀分布的。这种分析需要注意用户从一个细分群迁移到另一个细分群的情况，可能导致细分群OEC与总体OEC变化方向不一致。

### 4. 辛普森悖论
关于辛普森悖论的更详细分析，请参考[因果推断入门（一）](ci1.qmd)。

# 第4章：实验平台和文化

### 1. 实验成熟度模型

这部分讨论了实验不同成熟度阶段的目标重点，并从领导层影响、实验流程、实验平台的搭建等多个角度给出介绍，感兴趣的读者可以去阅读原文。

### 2. 基础设施和工具

实验平台主要有以下四个组件构成：

- 通过用户界面（UI）或应用程序接口（API）定义、设置和管理实验，并存储在实验系统配置中。
- 服务器端和客户端的实验部署，涵盖变体分配和参数化。
- 实验相关的工具化日志记录。
- 实验分析，包括指标的定义和计算，以及统计检验如p值。

关于前三点，读者可阅读原文深入了解更多细节。

#### 单层方法

单层方法（Single-Layer Method）：在实验数量较少时，可通过使用哈希函数将所有流量划分给每个实验变体。分段必须是随机的，且同一实验中的各分桶是统计相似的（关键指标的分布大致相同）。

#### 并行实验

为了满足同时进行多实验的要求，需要采用并行实验系统（Concurrent Experiments），即每个用户可以同时参与多个实验。常见的方法是创建多个实验层，每个层像单层方法一样运作。为确保层间实验的正交性，在用户分配到桶时添加层ID。同一实验的迭代通常共享相同的哈希ID，以确保用户的体验一致。

该方法的主要缺点是变体的交互可能会带来糟糕的用户体验，从而影响实验分析结果（例如文本和背景设成相似颜色）。改进方法包括嵌套设计和基于约束的设计：

- **嵌套设计**：系统参数被划分为多个层，以便让组合在一起可能产生较差用户体验的实验必须位于同一层，并通过设计防止针对同一用户运行实验。
- **基于约束的设计**：用于检测交互的自动化系统，可以在设计时就防止实验间的负面交互。

### 参考文献

- Kohavi, Ron, Diane Tang, and Ya Xu. *Trustworthy Online Controlled Experiments: A Practical Guide to A/B Testing (关键迭代：可信赖的线上对照试验)*. Cambridge University Press, 2020.

### 留言区
欢迎在下方留言讨论。如果您没有看到评论框，请确保您已登录 GitHub 账号。

{{< include ../../_includes/utterances.html >}}