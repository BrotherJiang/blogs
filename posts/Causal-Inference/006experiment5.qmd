---
title: "线上实验五：实验分析"
date: "2024-06-07"
keywords: ["假设检验", "统计学", "实验可信度"]
series: "Causal-Inference"
---

本文是《Trustworthy Online Controlled Experiments》（中文版《关键迭代：可信赖的线上对照试验》）的第五部分（17-23章）主要内容的总结。

# 第17章：线上对照实验中的统计学知识

假设读者已经具备了假设检验（hypothesis testing）相关的统计基础知识。由于原文在这部分的讲解较为简略，本文将根据自身的理解对部分概念进行补充说明，以方便大家理解。如有错漏，欢迎联系指正。

### 1. Z检验和t检验的使用条件

#### Z检验
Z检验适用于以下几种情况：

- 样本服从正态分布且标准差已知。
- 样本量较大，即使总体标准差未知，但根据中心极限定理，样本近似服从正态分布。

#### t检验
t检验适用于数据近似正态分布，样本量较小（通常n < 30），且总体标准差未知的情况。

当样本量非常大时，t检验和Z检验的结果趋于一致。

### 2. 正态性假设的检验方法

在进行假设检验之前，验证数据是否符合正态分布非常重要。以下是几种常用的正态性检验方法：

#### 置换检验（Permutation Test）
置换检验是一种非参数检验方法，通过多次随机重排数据集来评估原假设的显著性。具体步骤如下：

1. 计算原始数据的检验统计量（如均值差异）。
2. 随机重排数据集多次（通常是1000次或更多），每次计算相应的检验统计量。
3. 比较原始数据的检验统计量与重排数据集的分布，计算p值。

置换检验主要用于两组数据比较的非参数检验，如Mann-Whitney U检验。它不依赖于数据的分布假设，非常适合小样本数据。

#### 常用的正态性检验方法
- **Shapiro-Wilk检验**：适用于小样本的正态性检验，假设检验统计量W接近1表明数据近似正态分布。
- **Kolmogorov-Smirnov检验**：适用于较大样本的正态性检验，比较样本分布与正态分布的差异。
- **Anderson-Darling检验**：一种改进的K-S检验，更加注重分布尾部的差异。

### 3. p值和置信区间

**p值**是指在原假设为真时，观察到检验统计量等于或更极端的概率。p值用于衡量检验结果的显著性，如果p值小于预设的显著性水平（通常为0.05），则拒绝原假设。

**置信区间**是指在一定置信水平下（如95%），包含总体参数的区间。置信区间提供了估计参数的范围，而不仅仅是单一值。

#### 关于置信区间的表述：
- 正确：置信区间表示在样本数据的基础上估计总体参数的范围。
- 正确：置信水平95%表示：在重复抽样的情况下，95%的置信区间将包含总体参数。
- 正确：如果在0.05显著性水平下拒绝原假设，那么95%的置信区间将不包含零。
- 错误：单次实验中，该参数有95%概率在这个区间里。
- 错误：95%的样本会落在置信区间内。

### 4. 多重检验

多重检验问题是指在进行多个统计检验时，增加了得到至少一个显著结果的概率，从而增加了第一类错误（即假阳性）的风险。为了解决这个问题，通常需要对显著性水平进行调整。

#### Bonferroni校正
假设我们有 $m$ 个独立检验，每个检验的显著性水平为 $\alpha$。未调整的情况下，至少有一个检验显著的概率为：
$$
P(\text{至少一个显著}) = 1 - P(\text{所有检验不显著}) = 1 - (1 - \alpha)^m \approx 1 - e^{-\alpha m} 
$$

为了控制总体的显著性水平在 $\alpha$ 内，Bonferroni校正将每个检验的显著性水平调整为 $\frac{\alpha}{m}$。因此，每个检验的p值需要与 $\frac{\alpha}{m}$比较，而不是与 $\alpha$ 比较。这虽然能有效控制第一类错误率，但在检验数量较多时，会显著降低检验的检出能力（即增加第二类错误的风险）。

#### 常用的替代方法
1. **霍尔姆校正（Holm-Bonferroni Correction）**：
   - 将所有p值按从小到大的顺序排序，记为 $p_{(1)}, p_{(2)}, ..., p_{(m)}$。
   - 依次比较每个p值与调整后的显著性水平 $\frac{\alpha}{m+1-i}$，从最小的p值开始，直到找到第一个不显著的p值。
   - 该p值及其后的所有p值均视为不显著。

2. **Benjamini-Hochberg校正（Benjamini-Hochberg Procedure）**：
   - 将所有p值按从小到大的顺序排序，记为 $p_{(1)}, p_{(2)}, ..., p_{(m)}$。
   - 找到最大的 $i$ 使得 $p_{(i)} \leq \frac{i}{m} \alpha$。
   - 该p值及其前面的所有p值均视为显著。

### 5. 费舍尔统合分析

费舍尔统合分析（Fisher's Method for Combining P-values）是一种将多个独立实验结果的p值合并成一个统计量的方法，尤其适用于整合同一假设的多次实验结果。这种方法在提高统计功效和降低假阳性率方面非常有效。

#### 费舍尔方法的步骤
1. **计算每个独立实验的p值**：运行每个独立实验，并计算其对应的p值 $p_1, p_2, \ldots, p_k$。
2. **合并p值**：使用公式 $\chi^2_{2k}  = -2 \sum_{j=1}^{k} \ln(p_j)$ 计算合并后的检验统计量。
3. **检验显著性**：比较 $\chi^2_{2k}$ 与自由度为 $2k$ 的卡方分布的临界值。

### 6. 混淆矩阵及其相关指标

**混淆矩阵**是评估分类模型性能的工具，包含以下指标：

1. **准确率（Accuracy）**: 正确预测的样本数占总样本数的比例。
    $$
    \text{Accuracy} = \frac{TP + TN}{TP + FP + FN + TN}
    $$
    
2. **精确率（Precision）**: 正确预测为正例的样本数占预测为正例的样本数的比例。
    $$
    \text{Precision} = \frac{TP}{TP + FP}
   $$
    适用场景：推荐系统、刑事死刑判决、垃圾邮件检测、优质贷款客户筛选。即允许一定程度的遗漏，但是检测为正的例子，有足够的理由认为真的为正。

3. **召回率（Recall）**: 正确预测为正例的样本数占实际为正例的样本数的比例。
    $$
    \text{Recall} = \frac{TP}{TP + FN}
    $$
    适用场景：医疗检测、欺诈交易检测。即允许有一定程度的误判，但尽量不能遗漏任何可能为正的情况。

4. **F1分数（F1 Score）**: 精确率和召回率的调和平均。
   $$
    \text{F1 Score} = 2 \cdot \frac{\text{Precision} \cdot \text{Recall}}{\text{Precision} + \text{Recall}}
    $$

**ROC曲线和PR曲线**

- 定义决策规则： 
    $$
    \hat{y}_\tau(x) = \mathbb{I}(p(y=1 \mid x) \geq 1 - \tau)
    $$
- 假阳性（False Positive, FP）数：
    $$
    FP_\tau = \sum_{n=1}^N \mathbb{I}\left(\hat{y}_\tau\left(x_n\right)=1, y_n=0\right)
    $$
- 真阳性率（True Positive Rate, TPR）：
    $$
    TPR_\tau = p(\hat{y}=1 \mid y=1, \tau) = \frac{TP_\tau}{TP_\tau + FN_\tau}
   $$
- 假阳性率（False Positive Rate, FPR）：
    $$
    FPR_\tau = p(\hat{y}=1 \mid y=0, \tau) = \frac{FP_\tau}{FP_\tau + TN_\tau}
    $$

TPR对FPR的图称为接收者操作特征（ROC）曲线。在样本类别不平衡的情况下，使用ROC曲线评估模型性能可能会产生误导。具体来说，当正例（少数类）数量远小于负例（多数类）时，模型即使在大多数负例上表现良好（低FPR），也可能在正例上表现不佳（低TPR）。在这种情况下，仅看ROC曲线结果会过于乐观。

PR（精确率-召回率）曲线在评估不平衡数据集时更为合适。PR曲线通过展示精确率（Precision）和召回率（Recall）的权衡，能够更好地反映模型在少数类上的性能。PR曲线可能不是单调的，因此需要查看插值后的精确率（在至少达到某一召回率阈值时可以达到的最大精确率）。这种方法可以帮助我们更准确地理解模型在不平衡数据集上的表现。

ROC曲线下面积（AUC-ROC）和PR曲线下面积（AUC-PR）都是衡量分类模型性能的指标，数值越大表示模型性能越好。

### 参考文献

- Kohavi, Ron, Diane Tang, and Ya Xu. *Trustworthy Online Controlled Experiments: A Practical Guide to A/B Testing (关键迭代：可信赖的线上对照试验)*. Cambridge University Press, 2020.

